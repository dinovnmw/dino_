```html
<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Dino Music Player</title>
<style>
  @keyframes bgGradientShift {
    0%, 100% { background: linear-gradient(135deg, #2e3440, #3b4252); }
    50% { background: linear-gradient(135deg, #434c5e, #4c566a); }
  }
  body {
    margin: 0;
    padding: 0;
    height: 100vh;
    font-family: 'Montserrat', sans-serif;
    background: linear-gradient(135deg, #2e3440, #3b4252);
    animation: bgGradientShift 120s ease-in-out infinite;
    color: #d8dee9cc;
    display: flex;
    justify-content: center;
    align-items: center;
    user-select: none;
    overflow: auto;
    position: relative;
  }
  body::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, rgba(136, 170, 255, 0.15), rgba(187, 136, 255, 0.15));
    backdrop-filter: blur(12px);
    z-index: -2;
  }

  #particleCanvas {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1;
    pointer-events: none;
  }

  .app-container {
    width: 560px;
    background: rgba(30, 35, 45, 0.75);
    border-radius: 28px;
    box-shadow: 0 0 40px #7289daaa, inset 0 0 50px #4c566a88;
    padding: 32px;
    backdrop-filter: blur(12px);
    position: relative;
    display: flex;
    flex-direction: column;
    gap: 24px;
    transform-style: preserve-3d;
    perspective: 1000px;
    transition: transform 0.2s ease;
    will-change: transform;
  }

  h2 {
    font-weight: 300;
    font-size: 2.2rem;
    text-align: center;
    margin: 0 0 16px;
    color: #81a1c1;
    text-shadow: 0 0 8px #81a1c1cc;
  }

  .tab-bar {
    display: flex;
    justify-content: center;
    gap: 40px;
    margin-bottom: 12px;
    user-select: none;
  }
  .tab-button {
    font-weight: 500;
    font-size: 1.2rem;
    padding: 10px 28px;
    border-radius: 20px;
    border: 1.5px solid transparent;
    color: #81a1c1cc;
    cursor: pointer;
    background: transparent;
    transition: all 0.3s ease;
    box-shadow: 0 0 10px transparent;
  }
  .tab-button:hover {
    color: #a3b1c6dd;
    background: linear-gradient(135deg, #81a1c155, #88aaff55);
    transform: translateY(-2px);
  }
  .tab-button.active {
    color: #c4d9ff;
    border-color: #81a1c1bb;
    background: linear-gradient(135deg, #88aaffaa, #bb88ffaa);
    box-shadow: 0 0 30px #81a1c1bb;
  }

  .tabs-content {
    position: relative;
    min-height: 860px;
  }
  .tab-panel {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.4s ease, transform 0.4s ease;
    transform: translateY(20px);
  }
  .tab-panel.active {
    opacity: 1;
    pointer-events: auto;
    position: relative;
    transform: translateY(0);
  }

  .upload-section {
    border: 2px dashed #81a1c166;
    border-radius: 20px;
    padding: 24px 20px;
    text-align: center;
    font-size: 1.15rem;
    color: #81a1c1aa;
    cursor: pointer;
    user-select: none;
    transition: border-color 0.3s ease, background 0.3s ease;
    background: rgba(60, 68, 90, 0.15);
    box-shadow: inset 0 0 14px #7289da44;
    position: relative;
  }
  .upload-section:hover {
    border-color: #88aaffcc;
    color: #88aaffee;
    background: rgba(60, 68, 90, 0.25);
  }
  .upload-section input[type=file] {
    position: absolute;
    width: 100%;
    height: 100%;
    opacity: 0;
    top: 0;
    left: 0;
    cursor: pointer;
  }
  .file-info {
    margin-top: 16px;
    font-size: 1rem;
    color: #a3b1c6dd;
    user-select: text;
    min-height: 24px;
    text-align: center;
  }

  .url-section, .lyric-section, .history-section, .playlist-section {
    display: flex;
    flex-direction: column;
    gap: 12px;
    border: 2px dashed #81a1c166;
    border-radius: 20px;
    padding: 24px 20px;
    background: rgba(60, 68, 90, 0.15);
    box-shadow: inset 0 0 14px #7289da44;
  }
  .url-section input[type=text], .lyric-section textarea {
    padding: 12px 16px;
    border: 1.5px solid #81a1c1aa;
    border-radius: 12px;
    background: rgba(40, 44, 58, 0.45);
    color: #d8dee9;
    font-size: 1rem;
    outline: none;
    transition: border-color 0.3s ease;
    resize: none;
  }
  .url-section input[type=text]:focus, .lyric-section textarea:focus {
    border-color: #88aaffcc;
  }
  .url-section button, .lyric-section button, .history-section button, .playlist-section button {
    background: linear-gradient(135deg, #88aaff, #bb88ff);
    border: 1.8px solid transparent;
    border-radius: 18px;
    color: #d8dee9;
    padding: 12px 26px;
    font-size: 1.1rem;
    font-weight: 500;
    cursor: pointer;
    box-shadow: 0 0 16px #88aaffcc, 0 0 32px #bb88ff88;
    transition: all 0.3s ease;
  }
  .url-section button:hover:not(:disabled), .lyric-section button:hover:not(:disabled), .history-section button:hover:not(:disabled), .playlist-section button:hover:not(:disabled) {
    background: linear-gradient(135deg, #92b0ff, #cc99ff);
    box-shadow: 0 0 24px #88aaffee, 0 0 48px #bb88ffaa;
    transform: translateY(-2px);
  }
  .url-section button:disabled, .lyric-section button:disabled, .history-section button:disabled, .playlist-section button:disabled {
    cursor: not-allowed;
    opacity: 0.5;
  }

  .history-list, .playlist-list {
    max-height: 400px;
    overflow-y: auto;
    padding: 8px;
  }
  .history-item, .playlist-item {
    padding: 8px 12px;
    background: rgba(60, 68, 90, 0.25);
    border-radius: 12px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: background 0.3s ease;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .history-item:hover, .playlist-item:hover {
    background: rgba(80, 88, 110, 0.35);
  }
  .playlist-item.playing {
    background: linear-gradient(135deg, #88aaff55, #bb88ff55);
    color: #c4d9ff;
  }
  .playlist-item button {
    padding: 6px 12px;
    font-size: 0.9rem;
    background: linear-gradient(135deg, #ff6666, #ff8888);
    box-shadow: 0 0 10px #ff666688;
  }
  .playlist-item button:hover:not(:disabled) {
    background: linear-gradient(135deg, #ff7777, #ff9999);
    box-shadow: 0 0 15px #ff6666aa;
  }

  .controls {
    margin-top: 16px;
    display: flex;
    justify-content: center;
    gap: 18px;
    flex-wrap: wrap;
  }
  button {
    background: linear-gradient(135deg, #88aaff, #bb88ff);
    border: 1.8px solid transparent;
    border-radius: 18px;
    color: #d8dee9;
    padding: 12px 26px;
    font-size: 1.1rem;
    font-weight: 500;
    cursor: pointer;
    box-shadow: 0 0 16px #88aaffcc, 0 0 32px #bb88ff88;
    transition: all 0.3s ease;
    user-select: none;
  }
  button:hover:not(:disabled) {
    background: linear-gradient(135deg, #92b0ff, #cc99ff);
    box-shadow: 0 0 24px #88aaffee, 0 0 48px #bb88ffaa;
    transform: translateY(-2px);
  }
  button:active:not(:disabled) {
    transform: translateY(0);
    box-shadow: 0 0 20px #88aaffcc;
  }
  button:disabled {
    cursor: not-allowed;
    opacity: 0.5;
  }

  .volume-control, .progress-control {
    margin: 16px auto;
    width: 80%;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .volume-control input[type=range], .progress-control input[type=range] {
    -webkit-appearance: none;
    width: 100%;
    height: 6px;
    background: linear-gradient(to right, #88aaff 0%, #bb88ff var(--progress), #4c566a var(--progress), #4c566a 100%);
    border-radius: 3px;
    outline: none;
    cursor: pointer;
    transition: background 0.3s ease;
    box-shadow: 0 0 12px #7289da88;
    filter: drop-shadow(0 0 12px #88aaffee);
  }
  .volume-control input[type=range]::-webkit-slider-thumb, .progress-control input[type=range]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 20px;
    height: 20px;
    background: linear-gradient(135deg, #88aaff, #bb88ff);
    border-radius: 50%;
    box-shadow: 0 0 25px #88aaffdd, 0 0 50px #bb88ffaa;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    cursor: grab;
  }
  .volume-control input[type=range]::-webkit-slider-thumb:hover, .progress-control input[type=range]::-webkit-slider-thumb:hover {
    transform: scale(1.2);
    box-shadow: 0 0 35px #88aaffdd, 0 0 70px #bb88ffaa;
  }
  .volume-control input[type=range]::-webkit-slider-thumb:active, .progress-control input[type=range]::-webkit-slider-thumb:active {
    transform: scale(1.1);
    box-shadow: 0 0 30px #88aaffee, 0 0 60px #bb88ffcc;
    cursor: grabbing;
  }
  .volume-control input[type=range]::-moz-range-thumb, .progress-control input[type=range]::-moz-range-thumb {
    width: 20px;
    height: 20px;
    background: linear-gradient(135deg, #88aaff, #bb88ff);
    border: none;
    border-radius: 50%;
    box-shadow: 0 0 25px #88aaffdd, 0 0 50px #bb88ffaa;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    cursor: grab;
  }
  .volume-control input[type=range]::-moz-range-thumb:hover, .progress-control input[type=range]::-moz-range-thumb:hover {
    transform: scale(1.2);
    box-shadow: 0 0 35px #88aaffdd, 0 0 70px #bb88ffaa;
  }
  .volume-control input[type=range]::-moz-range-thumb:active, .progress-control input[type=range]::-moz-range-thumb:active {
    transform: scale(1.1);
    box-shadow: 0 0 30px #88aaffee, 0 0 60px #bb88ffcc;
    cursor: grabbing;
  }

  .waveform-container {
    margin-top: 24px;
    position: relative;
    z-index: 1;
  }
  .waveform {
    height: 80px;
    width: 100%;
    position: relative;
    border-radius: 12px;
    background: rgba(40, 44, 58, 0.45);
    box-shadow: inset 0 0 14px #6f86ff88;
    filter: drop-shadow(0 0 16px #90aaffdd);
    transition: filter 0.3s ease;
  }
  canvas {
    width: 100%;
    height: 100%;
    border-radius: 12px;
    display: block;
  }
  .frequency-labels {
    display: flex;
    justify-content: space-between;
    margin-top: 8px;
    font-size: 0.9rem;
    color: #81a1c1aa;
    text-shadow: 0 0 4px #81a1c166;
  }

  .image-preview-frame {
    width: 480px;
    height: 480px;
    max-width: 100%;
    background: linear-gradient(45deg, #88aaff, #bb88ff) border-box;
    border: 3px solid transparent;
    border-radius: 28px;
    box-shadow: inset 0 0 24px #7699e0aa, 0 0 12px #90aaffcc;
    overflow: hidden;
    display: flex;
    justify-content: center;
    align-items: center;
    user-select: none;
    transition: transform 0.08s ease, box-shadow 0.3s ease, filter 0.3s ease;
    margin: 0 auto;
    will-change: transform, box-shadow;
    filter: drop-shadow(0 0 12px #90aaffcc);
  }
  .image-preview-frame:hover {
    transform: scale(1.03);
    box-shadow: inset 0 0 30px #7699e0cc, 0 0 16px #90aaffdd;
    filter: drop-shadow(0 0 16px #90aaffdd);
  }
  .image-preview-frame img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  .image-preview-frame span {
    color: #7f8ea8;
    font-size: 1.5rem;
    user-select: none;
  }

  .lyrics-container {
    height: 150px;
    overflow: hidden;
    position: relative;
    margin-top: 24px;
    border-radius: 16px;
    background: rgba(40, 44, 58, 0.45);
    box-shadow: inset 0 0 18px #6f86ff88;
  }
  .lyrics {
    position: absolute;
    width: 100%;
    text-align: center;
    color: #d8dee9;
    font-size: 1.3rem;
    font-weight: 300;
    transition: transform 0.5s ease;
  }
  .lyrics p {
    margin: 8px 0;
    padding: 0 20px;
    text-shadow: 0 0 8px #81a1c1cc;
  }
  .lyrics p.active {
    color: #88aaff;
    font-weight: 500;
    transform: scale(1.1);
    text-shadow: 0 0 10px #88aaffee;
  }

  .upload-tab-content {
    display: flex;
    flex-direction: column;
    gap: 32px;
    padding: 12px 20px 28px;
    height: 100%;
    overflow-y: auto;
  }

  .rain {
    pointer-events: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    overflow: hidden;
    z-index: 0;
  }
  .drop {
    position: absolute;
    bottom: 100%;
    width: 2px;
    height: 22px;
    background: rgba(130, 155, 230, 0.06);
    border-radius: 1px;
    animation-name: fall;
    animation-timing-function: linear;
    animation-iteration-count: infinite;
    filter: drop-shadow(0 0 6px #7699e099);
  }
  .drop.large {
    width: 3px;
    height: 30px;
    opacity: 0.08;
  }
  @keyframes fall {
    to { transform: translateY(110vh); opacity: 0; }
  }

  @media (max-width: 600px) {
    .app-container {
      width: 90%;
      padding: 24px;
    }
    .image-preview-frame {
      width: 320px;
      height: 320px;
    }
    .waveform {
      height: 60px;
    }
    .tabs-content {
      min-height: 700px;
    }
    .controls {
      gap: 12px;
    }
    button {
      padding: 10px 20px;
      font-size: 1rem;
    }
  }
</style>
</head>
<body>
<canvas id="particleCanvas"></canvas>
<div class="app-container" id="app">
  <h2>Dino Music Player</h2>

  <div class="tab-bar">
    <button class="tab-button active" data-tab="play">Nghe Nhạc</button>
    <button class="tab-button" data-tab="upload">Upload</button>
    <button class="tab-button" data-tab="playlist">Danh sách</button>
  </div>

  <div class="tabs-content">
    <section class="tab-panel active" id="tab-play">
      <div class="image-preview-frame" id="imagePreviewFrame">
        <span>Chưa có ảnh/GIF</span>
      </div>

      <div class="waveform-container">
        <canvas class="waveform" id="waveCanvas"></canvas>
        <div class="frequency-labels">
          <span>0Hz</span>
          <span>2kHz</span>
          <span>4kHz</span>
          <span>8kHz</span>
          <span>16kHz</span>
        </div>
      </div>

      <div class="progress-control">
        <input type="range" id="progressSlider" min="0" max="100" step="0.1" value="0" disabled />
      </div>

      <div class="lyrics-container" id="lyricsContainer">
        <div class="lyrics" id="lyrics">
          <p>Chưa có lời bài hát</p>
        </div>
      </div>

      <div class="volume-control">
        <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="1" />
      </div>

      <div class="controls">
        <button id="btnPlayPause" disabled>▶ Play</button>
        <button id="btnLoop" disabled>Loop: Off</button>
        <button id="btnEnhance" disabled>Cảm Âm: Off</button>
        <button id="btnEnhanceMode" disabled>Chế độ: Bass Boost</button>
      </div>

      <div class="file-info" id="musicInfo">Vui lòng upload hoặc nhập link nhạc</div>
    </section>

    <section class="tab-panel" id="tab-upload">
      <div class="upload-tab-content">
        <div class="url-section">
          <input type="text" id="musicUrl" placeholder="Nhập link file nhạc (MP3, WAV,...)" />
          <button id="btnLoadUrl">Tải từ URL</button>
        </div>
        <label class="upload-section">
          Upload Nhạc (MP3, WAV,...)
          <input type="file" id="musicFile" accept="audio/*" />
        </label>
        <div class="lyric-section">
          <textarea id="lyricInput" rows="4" placeholder="Nhập lời bài hát (định dạng: [mm:ss.xx] Lời bài hát, ví dụ: [00:03.50] Xin chào)"></textarea>
          <button id="btnSubmitLyric">Xác nhận lời bài hát</button>
        </div>
        <label class="upload-section">
          Upload Ảnh/GIF (Tự crop vuông 1x1)
          <input type="file" id="imageFile" accept="image/*" />
        </label>
        <div class="history-section">
          <h3>Lịch sử phát nhạc</h3>
          <div class="history-list" id="historyList">
            <p>Chưa có lịch sử phát nhạc</p>
          </div>
          <button id="btnClearHistory">Xóa lịch sử</button>
        </div>
      </div>
    </section>

    <section class="tab-panel" id="tab-playlist">
      <div class="playlist-section">
        <h3>Danh sách phát</h3>
        <div class="playlist-list" id="playlistList">
          <p>Chưa có bài hát trong danh sách phát</p>
        </div>
        <button id="btnClearPlaylist">Xóa danh sách phát</button>
      </div>
    </section>
  </div>
</div>

<div id="rain" class="rain"></div>

<script>
  // Particle background
  const particleCanvas = document.getElementById('particleCanvas');
  const pCtx = particleCanvas.getContext('2d');
  particleCanvas.width = window.innerWidth * window.devicePixelRatio;
  particleCanvas.height = window.innerHeight * window.devicePixelRatio;
  pCtx.scale(window.devicePixelRatio, window.devicePixelRatio);

  const particles = [];
  const particleCount = 50;

  class Particle {
    constructor() {
      this.x = Math.random() * particleCanvas.width / window.devicePixelRatio;
      this.y = Math.random() * particleCanvas.height / window.devicePixelRatio;
      this.vx = (Math.random() - 0.5) * 2;
      this.vy = (Math.random() - 0.5) * 2;
      this.size = Math.random() * 2 + 1;
      this.baseSize = this.size;
      this.trail = [];
      this.trailLength = 5;
      this.hue = Math.random() * 60 + 240; // Blue-purple range (240-300)
    }
    update(energy) {
      this.x += this.vx;
      this.y += this.vy;
      if (this.x < 0 || this.x > particleCanvas.width / window.devicePixelRatio) this.vx *= -1;
      if (this.y < 0 || this.y > particleCanvas.height / window.devicePixelRatio) this.vy *= -1;
      this.size = this.baseSize + energy * 2;
      this.trail.push({ x: this.x, y: this.y });
      if (this.trail.length > this.trailLength) this.trail.shift();
    }
    draw(energy) {
      pCtx.save();
      pCtx.globalCompositeOperation = 'lighter';
      const gradient = pCtx.createLinearGradient(this.x, this.y, this.x + this.vx * 3, this.y + this.vy * 3);
      gradient.addColorStop(0, `hsla(${this.hue}, 70%, 60%, ${0.2 + energy * 0.1})`);
      gradient.addColorStop(1, `hsla(${this.hue + 30}, 70%, 60%, ${0.2 + energy * 0.1})`);

      for (let i = 0; i < this.trail.length; i++) {
        const alpha = i / this.trail.length;
        pCtx.beginPath();
        pCtx.arc(this.trail[i].x, this.trail[i].y, this.size * alpha, 0, Math.PI * 2);
        pCtx.fillStyle = gradient;
        pCtx.fill();
      }

      pCtx.beginPath();
      pCtx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
      pCtx.fillStyle = gradient;
      pCtx.restore();
    }
  }

  for (let i = 0; i < particleCount; i++) {
    particles.push(new Particle());
  }

  let lastParticleUpdate = 0;
  function animateParticles(energy) {
    const now = performance.now();
    if (now - lastParticleUpdate < 33) { // ~30fps
      requestAnimationFrame(() => animateParticles(energy));
      return;
    }
    lastParticleUpdate = now;
    pCtx.clearRect(0, 0, particleCanvas.width, particleCanvas.height);
    particles.forEach(p => {
      p.update(energy);
      p.draw(energy);
    });
    requestAnimationFrame(() => animateParticles(energy));
  }
  animateParticles(0);

  window.addEventListener('resize', () => {
    particleCanvas.width = window.innerWidth * window.devicePixelRatio;
    particleCanvas.height = window.innerHeight * window.devicePixelRatio;
    pCtx.scale(window.devicePixelRatio, window.devicePixelRatio);
  });

  // Tab switching
  const tabs = document.querySelectorAll('.tab-button');
  const panels = document.querySelectorAll('.tab-panel');
  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      tabs.forEach(t => t.classList.remove('active'));
      panels.forEach(p => p.classList.remove('active'));
      tab.classList.add('active');
      const target = tab.dataset.tab;
      document.getElementById('tab-' + target).classList.add('active');
    });
  });

  // Audio setup
  const waveCanvas = document.getElementById('waveCanvas');
  const ctx = waveCanvas.getContext('2d');
  waveCanvas.width = waveCanvas.clientWidth * window.devicePixelRatio;
  waveCanvas.height = waveCanvas.clientHeight * window.devicePixelRatio;
  ctx.scale(window.devicePixelRatio, window.devicePixelRatio);

  let audioCtx = null;
  let audioBuffer;
  let audioSource;
  let analyser;
  let dataArray;
  let bufferLength;
  let gainNode;
  let startTime = 0;
  let pauseTime = 0;

  let audioPlaying = false;
  let loopOn = false;
  let enhanceOn = false;
  let enhanceMode = 'bass';
  let playlist = JSON.parse(localStorage.getItem('playlist')) || [];
  let currentPlaylistIndex = -1;

  const btnPlayPause = document.getElementById('btnPlayPause');
  const btnLoop = document.getElementById('btnLoop');
  const btnEnhance = document.getElementById('btnEnhance');
  const btnEnhanceMode = document.getElementById('btnEnhanceMode');
  const musicInfo = document.getElementById('musicInfo');
  const lyricsContainer = document.getElementById('lyricsContainer');
  const lyricsElement = document.getElementById('lyrics');
  const volumeSlider = document.getElementById('volumeSlider');
  const progressSlider = document.getElementById('progressSlider');
  const lyricInput = document.getElementById('lyricInput');
  const btnSubmitLyric = document.getElementById('btnSubmitLyric');
  const imagePreviewFrame = document.getElementById('imagePreviewFrame');
  const appContainer = document.getElementById('app');
  const historyList = document.getElementById('historyList');
  const btnClearHistory = document.getElementById('btnClearHistory');
  const playlistList = document.getElementById('playlistList');
  const btnClearPlaylist = document.getElementById('btnClearPlaylist');

  let lyricsData = [];
  let currentLyricIndex = -1;
  let musicHistory = JSON.parse(localStorage.getItem('musicHistory')) || [];

  // Blue switch click sound
  const clickSound = new Audio('https://cdn.pixabay.com/audio/2022/03/24/02-58-18-463_960x540.mp3');
  clickSound.volume = 0.3;

  document.addEventListener('keydown', () => {
    clickSound.currentTime = 0;
    clickSound.play().catch(() => {});
  });

  function setupAudioContext(buffer) {
    if (audioSource) {
      try {
        audioSource.stop();
        audioSource.disconnect();
      } catch {}
      audioSource = null;
    }
    if (audioCtx && audioCtx.state !== 'closed') {
      try {
        audioCtx.close().catch(() => {});
      } catch {}
    }
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    audioSource = audioCtx.createBufferSource();
    audioSource.buffer = buffer;
    audioSource.loop = loopOn;

    gainNode = audioCtx.createGain();
    gainNode.gain.setValueAtTime(volumeSlider.value, audioCtx.currentTime);

    const analyserNode = audioCtx.createAnalyser();
    analyser = analyserNode;
    analyser.fftSize = 256;
    bufferLength = analyser.frequencyBinCount;
    dataArray = new Uint8Array(bufferLength);

    let sourceNode = audioSource;

    if (enhanceOn) {
      if (enhanceMode === 'bass') {
        const lowShelf = audioCtx.createBiquadFilter();
        lowShelf.type = 'lowshelf';
        lowShelf.frequency.value = 100;
        lowShelf.gain.value = 10;
        const highShelf = audioCtx.createBiquadFilter();
        highShelf.type = 'highshelf';
        highShelf.frequency.value = 4000;
        highShelf.gain.value = 6;
        sourceNode.connect(lowShelf);
        lowShelf.connect(highShelf);
        highShelf.connect(gainNode);
      } else if (enhanceMode === 'vocal') {
        const peaking = audioCtx.createBiquadFilter();
        peaking.type = 'peaking';
        peaking.frequency.value = 2000;
        peaking.gain.value = 8;
        peaking.Q.value = 1;
        const highShelf = audioCtx.createBiquadFilter();
        highShelf.type = 'highshelf';
        highShelf.frequency.value = 6000;
        highShelf.gain.value = 4;
        sourceNode.connect(peaking);
        peaking.connect(highShelf);
        highShelf.connect(gainNode);
      } else if (enhanceMode === 'treble') {
        const highShelf = audioCtx.createBiquadFilter();
        highShelf.type = 'highshelf';
        highShelf.frequency.value = 8000;
        highShelf.gain.value = 10;
        sourceNode.connect(highShelf);
        highShelf.connect(gainNode);
      } else if (enhanceMode === 'balanced') {
        const lowShelf = audioCtx.createBiquadFilter();
        lowShelf.type = 'lowshelf';
        lowShelf.frequency.value = 100;
        lowShelf.gain.value = 5;
        const highShelf = audioCtx.createBiquadFilter();
        highShelf.type = 'highshelf';
        highShelf.frequency.value = 6000;
        highShelf.gain.value = 5;
        sourceNode.connect(lowShelf);
        lowShelf.connect(highShelf);
        highShelf.connect(gainNode);
      }
    } else {
      sourceNode.connect(gainNode);
    }

    gainNode.connect(analyserNode);
    analyserNode.connect(audioCtx.destination);
    updateAudioSourceEnded();
  }

  // Volume control
  volumeSlider.addEventListener('input', () => {
    const volume = volumeSlider.value;
    if (gainNode) {
      gainNode.gain.setValueAtTime(volume, audioCtx.currentTime);
    }
    volumeSlider.style.setProperty('--progress', `${volume * 100}%`);
  });

  // Progress control
  function updateProgress() {
    if (!audioPlaying || !audioBuffer) return;
    const currentTime = audioCtx.currentTime - startTime + pauseTime;
    const duration = audioBuffer.duration;
    const progress = (currentTime / duration) * 100;
    progressSlider.value = Math.min(progress, 100);
    progressSlider.style.setProperty('--progress', `${progress}%`);
    requestAnimationFrame(updateProgress);
  }

  progressSlider.addEventListener('input', () => {
    if (!audioBuffer) return;
    const progress = progressSlider.value / 100;
    const seekTime = audioBuffer.duration * progress;

    if (audioPlaying) {
      if (audioSource) {
        audioSource.stop();
        audioSource.disconnect();
        audioSource = null;
      }
      setupAudioContext(audioBuffer);
      startTime = audioCtx.currentTime;
      pauseTime = seekTime;
      audioSource.start(0, pauseTime);
      updateProgress();
      updateLyrics();
    } else {
      pauseTime = seekTime;
      progressSlider.value = (pauseTime / audioBuffer.duration) * 100;
      progressSlider.style.setProperty('--progress', `${(pauseTime / audioBuffer.duration) * 100}%`);
    }
  });

  // Draw frequency spectrum and update image scale
  let lastScale = 1;
  let lastGlow = 12;
  let lastImageUpdate = 0;
  function updateImageScale() {
    const now = performance.now();
    if (now - lastImageUpdate < 33) { // ~30fps
      requestAnimationFrame(updateImageScale);
      return;
    }
    lastImageUpdate = now;

    if (!analyser || !audioPlaying) {
      imagePreviewFrame.style.transform = `scale(${lastScale})`;
      imagePreviewFrame.style.boxShadow = `inset 0 0 24px #7699e0aa, 0 0 ${lastGlow}px #90aaffcc`;
      imagePreviewFrame.style.filter = `drop-shadow(0 0 ${lastGlow}px #90aaffcc)`;
      requestAnimationFrame(updateImageScale);
      return;
    }

    analyser.getByteFrequencyData(dataArray);
    const sum = dataArray.reduce((a, b) => a + b, 0);
    const energy = sum / (bufferLength * 255);
    const scale = 0.9 + energy * 0.2;
    lastScale = lastScale * 0.7 + scale * 0.3;
    const glow = 12 + energy * 2;
    lastGlow = lastGlow * 0.7 + glow * 0.3;

    imagePreviewFrame.style.transform = `scale(${lastScale})`;
    imagePreviewFrame.style.boxShadow = `inset 0 0 24px #7699e0aa, 0 0 ${lastGlow}px #90aaffcc`;
    imagePreviewFrame.style.filter = `drop-shadow(0 0 ${lastGlow}px #90aaffcc)`;

    requestAnimationFrame(updateImageScale);
  }
  updateImageScale();

  let lastWaveformUpdate = 0;
  function drawWaveform() {
    const now = performance.now();
    if (now - lastWaveformUpdate < 33) { // ~30fps
      requestAnimationFrame(drawWaveform);
      return;
    }
    lastWaveformUpdate = now;

    ctx.clearRect(0, 0, waveCanvas.width, waveCanvas.height);
    if (!analyser || !audioPlaying) {
      return;
    }

    analyser.getByteFrequencyData(dataArray);

    const w = waveCanvas.width / window.devicePixelRatio;
    const h = waveCanvas.height / window.devicePixelRatio;
    const barWidth = w / bufferLength;
    let x = 0;

    const sum = dataArray.reduce((a, b) => a + b, 0);
    const energy = sum / (bufferLength * 255);

    const gradient = ctx.createLinearGradient(0, h, 0, 0);
    gradient.addColorStop(0, enhanceOn ? '#bb88ffcc' : '#88aaffcc');
    gradient.addColorStop(1, enhanceOn ? '#cc99ffcc' : '#92b0ffcc');

    ctx.fillStyle = gradient;
    ctx.shadowColor = enhanceOn ? '#bb88ff88' : '#90aaff88';
    ctx.shadowBlur = 8;

    for (let i = 0; i < bufferLength; i++) {
      const barHeight = (dataArray[i] / 255) * h * 1.2;
      ctx.fillRect(x, h - barHeight, barWidth * 0.9, barHeight);
      x += barWidth;
    }

    waveCanvas.parentElement.style.filter = `drop-shadow(0 0 ${12 + energy * 4}px ${enhanceOn ? '#bb88ff88' : '#90aaff88'})`;
    animateParticles(energy);
    requestAnimationFrame(drawWaveform);
  }
  drawWaveform();

  // 3D tilt effect
  appContainer.addEventListener('mousemove', (e) => {
    const rect = appContainer.getBoundingClientRect();
    const centerX = rect.left + rect.width / 2;
    const centerY = rect.top + rect.height / 2;
    const mouseX = e.clientX - centerX;
    const mouseY = e.clientY - centerY;

    const maxTilt = 15;
    const tiltX = (mouseY / (rect.height / 2)) * maxTilt;
    const tiltY = -(mouseX / (rect.width / 2)) * maxTilt;

    appContainer.style.transform = `perspective(1000px) rotateX(${tiltX}deg) rotateY(${tiltY}deg)`;
  });

  appContainer.addEventListener('mouseleave', () => {
    appContainer.style.transform = 'perspective(1000px) rotateX(0deg) rotateY(0deg)';
  });

  function parseLyrics(text) {
    const lines = text.split('\n');
    const parsed = [];
    const timeRegex = /\[(\d{2}):(\d{2})\.(\d{2})\](.*)/;

    lines.forEach(line => {
      const match = line.match(timeRegex);
      if (match) {
        const minutes = parseInt(match[1]);
        const seconds = parseInt(match[2]);
        const centiseconds = parseInt(match[3]);
        const text = match[4].trim();
        const time = minutes * 60 + seconds + centiseconds / 100;
        parsed.push({ time, text });
      }
    });

    return parsed.sort((a, b) => a.time - b.time);
  }

  function updateLyrics() {
    if (!audioPlaying || !lyricsData.length) return;
    requestAnimationFrame(updateLyrics);

    const currentTime = audioCtx.currentTime - startTime + pauseTime;
    let newIndex = -1;

    for (let i = 0; i < lyricsData.length; i++) {
      if (currentTime >= lyricsData[i].time) {
        newIndex = i;
      } else {
        break;
      }
    }

    if (newIndex !== currentLyricIndex) {
      currentLyricIndex = newIndex;
      lyricsElement.innerHTML = '';
      const fragment = document.createDocumentFragment();

      for (let i = Math.max(0, newIndex - 2); i < Math.min(lyricsData.length, newIndex + 3); i++) {
        const p = document.createElement('p');
        p.textContent = lyricsData[i].text || '♪';
        if (i === newIndex) p.classList.add('active');
        fragment.appendChild(p);
      }

      lyricsElement.appendChild(fragment);
      const offset = newIndex * 32;
      lyricsElement.style.transform = `translateY(${150 - offset}px)`;
    }
  }

  // Submit lyric
  btnSubmitLyric.addEventListener('click', () => {
    const lyricText = lyricInput.value.trim();
    if (!lyricText) {
      musicInfo.textContent = 'Vui lòng nhập lời bài hát';
      return;
    }

    lyricsData = parseLyrics(lyricText);
    if (lyricsData.length === 0) {
      musicInfo.textContent = 'Định dạng lời bài hát không hợp lệ. Sử dụng: [mm:ss.xx] Lời bài hát';
      lyricsElement.innerHTML = '<p>Không tìm thấy lời bài hát hợp lệ</p>';
    } else {
      musicInfo.textContent = 'Đã nhập lời bài hát thành công';
      lyricsElement.innerHTML = '<p>Đã tải lời bài hát</p>';
      lyricInput.value = '';
    }
  });

  // Update music history display
  function updateHistoryDisplay() {
    if (musicHistory.length === 0) {
      historyList.innerHTML = '<p>Chưa có lịch sử phát nhạc</p>';
      return;
    }
    historyList.innerHTML = '';
    musicHistory.forEach((item, index) => {
      const div = document.createElement('div');
      div.classList.add('history-item');
      div.textContent = item.name;
      div.addEventListener('click', () => loadFromHistory(index));
      historyList.appendChild(div);
    });
  }

  // Load music from history
  async function loadFromHistory(index) {
    const item = musicHistory[index];
    musicInfo.textContent = `Đang tải: ${item.name}`;
    btnPlayPause.disabled = true;
    btnLoop.disabled = true;
    btnEnhance.disabled = true;
    btnEnhanceMode.disabled = true;
    volumeSlider.disabled = true;
    progressSlider.disabled = true;

    try {
      let arrayBuffer;
      if (item.type === 'url') {
        const response = await fetch(item.url, { mode: 'cors' });
        if (!response.ok) throw new Error('Không thể tải file từ URL');
        arrayBuffer = await response.arrayBuffer();
      } else {
        arrayBuffer = item.data;
      }

      if (audioSource) {
        try {
          audioSource.stop();
          audioSource.disconnect();
        } catch {}
        audioSource = null;
      }
      if (audioCtx && audioCtx.state !== 'closed') {
        try {
          audioCtx.close().catch(() => {});
        } catch {}
      }

      audioBuffer = await (new (window.AudioContext || window.webkitAudioContext)()).decodeAudioData(arrayBuffer);
      setupAudioContext(audioBuffer);

      musicInfo.textContent = `Đã chọn: ${item.name}`;
      btnPlayPause.disabled = false;
      btnLoop.disabled = false;
      btnEnhance.disabled = false;
      btnEnhanceMode.disabled = false;
      volumeSlider.disabled = false;
      progressSlider.disabled = false;
      progressSlider.max = audioBuffer.duration;
      progressSlider.value = 0;

      btnPlayPause.textContent = '▶ Play';
      audioPlaying = false;
      pauseTime = 0;
      currentPlaylistIndex = -1;
      updatePlaylistDisplay();
      if (!lyricsData.length) {
        lyricsElement.innerHTML = '<p>Chưa có lời bài hát</p>';
      }
    } catch (error) {
      musicInfo.textContent = 'Lỗi: Không thể tải file từ lịch sử';
    }
  }

  // Clear history
  btnClearHistory.addEventListener('click', () => {
    musicHistory = [];
    localStorage.setItem('musicHistory', JSON.stringify(musicHistory));
    updateHistoryDisplay();
    musicInfo.textContent = 'Đã xóa lịch sử phát nhạc';
  });

  // Playlist management
  function updatePlaylistDisplay() {
    if (playlist.length === 0) {
      playlistList.innerHTML = '<p>Chưa có bài hát trong danh sách phát</p>';
      return;
    }
    playlistList.innerHTML = '';
    playlist.forEach((item, index) => {
      const div = document.createElement('div');
      div.classList.add('playlist-item');
      if (index === currentPlaylistIndex) div.classList.add('playing');
      const nameSpan = document.createElement('span');
      nameSpan.textContent = item.name;
      const removeBtn = document.createElement('button');
      removeBtn.textContent = 'Xóa';
      removeBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        removeFromPlaylist(index);
      });
      div.appendChild(nameSpan);
      div.appendChild(removeBtn);
      div.addEventListener('click', () => loadFromPlaylist(index));
      playlistList.appendChild(div);
    });
  }

  function addToPlaylist(item) {
    playlist.push(item);
    localStorage.setItem('playlist', JSON.stringify(playlist));
    updatePlaylistDisplay();
  }

  function removeFromPlaylist(index) {
    playlist.splice(index, 1);
    localStorage.setItem('playlist', JSON.stringify(playlist));
    if (index === currentPlaylistIndex) {
      if (audioSource) {
        try {
          audioSource.stop();
          audioSource.disconnect();
        } catch {}
        audioSource = null;
        audioPlaying = false;
        btnPlayPause.textContent = '▶ Play';
        currentPlaylistIndex = -1;
        musicInfo.textContent = 'Vui lòng chọn bài hát từ danh sách phát';
      }
    } else if (index < currentPlaylistIndex) {
      currentPlaylistIndex--;
    }
    updatePlaylistDisplay();
  }

  btnClearPlaylist.addEventListener('click', () => {
    playlist = [];
    localStorage.setItem('playlist', JSON.stringify(playlist));
    updatePlaylistDisplay();
    if (audioSource) {
      try {
        audioSource.stop();
        audioSource.disconnect();
      } catch {}
      audioSource = null;
      audioPlaying = false;
      btnPlayPause.textContent = '▶ Play';
      currentPlaylistIndex = -1;
      musicInfo.textContent = 'Đã xóa danh sách phát';
    }
  });

  async function loadFromPlaylist(index) {
    const item = playlist[index];
    currentPlaylistIndex = index;
    musicInfo.textContent = `Đang tải: ${item.name}`;
    btnPlayPause.disabled = true;
    btnLoop.disabled = true;
    btnEnhance.disabled = true;
    btnEnhanceMode.disabled = true;
    volumeSlider.disabled = true;
    progressSlider.disabled = true;

    try {
      let arrayBuffer;
      if (item.type === 'url') {
        const response = await fetch(item.url, { mode: 'cors' });
        if (!response.ok) throw new Error('Không thể tải file từ URL');
        arrayBuffer = await response.arrayBuffer();
      } else {
        arrayBuffer = item.data;
      }

      audioBuffer = await (new (window.AudioContext || window.webkitAudioContext)()).decodeAudioData(arrayBuffer);
      setupAudioContext(audioBuffer);

      musicInfo.textContent = `Đang phát: ${item.name}`;
      btnPlayPause.disabled = false;
      btnLoop.disabled = false;
      btnEnhance.disabled = false;
      btnEnhanceMode.disabled = false;
      volumeSlider.disabled = false;
      progressSlider.disabled = false;
      progressSlider.max = audioBuffer.duration;
      progressSlider.value = 0;

      btnPlayPause.textContent = '▶ Play';
      audioPlaying = false;
      pauseTime = 0;
      updatePlaylistDisplay();
      if (!lyricsData.length) {
        lyricsElement.innerHTML = '<p>Chưa có lời bài hát</p>';
      }
    } catch (error) {
      musicInfo.textContent = 'Lỗi: Không thể tải bài hát từ danh sách phát';
    }
  }

  function playNext() {
    if (loopOn && currentPlaylistIndex >= 0) {
      loadFromPlaylist(currentPlaylistIndex);
      btnPlayPause.click();
    } else if (currentPlaylistIndex < playlist.length - 1) {
      loadFromPlaylist(currentPlaylistIndex + 1);
      btnPlayPause.click();
    } else {
      audioPlaying = false;
      btnPlayPause.textContent = '▶ Play';
      musicInfo.textContent = 'Đã phát hết danh sách';
      currentPlaylistIndex = -1;
      updatePlaylistDisplay();
    }
  }

  function updateAudioSourceEnded() {
    if (audioSource) {
      audioSource.onended = () => {
        if (!loopOn) {
          playNext();
        }
      };
    }
  }

  // Upload music
  const musicFileInput = document.getElementById('musicFile');
  musicFileInput.addEventListener('change', async (e) => {
    if (!e.target.files.length) return;
    const file = e.target.files[0];
    if (!file.type.startsWith('audio')) {
      musicInfo.textContent = 'Vui lòng chọn file âm thanh hợp lệ';
      return;
    }
    musicInfo.textContent = `Đang tải: ${file.name}`;
    btnPlayPause.disabled = true;
    btnLoop.disabled = true;
    btnEnhance.disabled = true;
    btnEnhanceMode.disabled = true;
    volumeSlider.disabled = true;
    progressSlider.disabled = true;

    const arrayBuffer = await file.arrayBuffer();
    addToPlaylist({ type: 'file', name: file.name, data: arrayBuffer });
    musicHistory.push({ type: 'file', name: file.name, data: arrayBuffer });
    localStorage.setItem('musicHistory', JSON.stringify(musicHistory));
    updateHistoryDisplay();

    audioBuffer = await (new (window.AudioContext || window.webkitAudioContext)()).decodeAudioData(arrayBuffer);
    setupAudioContext(audioBuffer);

    musicInfo.textContent = `Đã chọn: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`;
    btnPlayPause.disabled = false;
    btnLoop.disabled = false;
    btnEnhance.disabled = false;
    btnEnhanceMode.disabled = false;
    volumeSlider.disabled = false;
    progressSlider.disabled = false;
    progressSlider.max = audioBuffer.duration;
    progressSlider.value = 0;

    btnPlayPause.textContent = '▶ Play';
    audioPlaying = false;
    pauseTime = 0;
    currentPlaylistIndex = playlist.length - 1;
    updatePlaylistDisplay();
    if (!lyricsData.length) {
      lyricsElement.innerHTML = '<p>Chưa có lời bài hát</p>';
    }
  });

  // Load music from URL
  const musicUrlInput = document.getElementById('musicUrl');
  const btnLoadUrl = document.getElementById('btnLoadUrl');
  btnLoadUrl.addEventListener('click', async () => {
    const url = musicUrlInput.value.trim();
    if (!url) {
      musicInfo.textContent = 'Vui lòng nhập URL hợp lệ';
      return;
    }

    musicInfo.textContent = 'Đang tải từ URL...';
    btnPlayPause.disabled = true;
    btnLoop.disabled = true;
    btnEnhance.disabled = true;
    btnEnhanceMode.disabled = true;
    btnLoadUrl.disabled = true;
    volumeSlider.disabled = true;
    progressSlider.disabled = true;

    try {
      const response = await fetch(url, { mode: 'cors' });
      if (!response.ok) throw new Error('Không thể tải file từ URL');

      const contentType = response.headers.get('content-type');
      if (!contentType || !contentType.startsWith('audio/')) {
        musicInfo.textContent = 'URL không phải file âm thanh hợp lệ';
        btnLoadUrl.disabled = false;
        volumeSlider.disabled = false;
        progressSlider.disabled = false;
        return;
      }

      const arrayBuffer = await response.arrayBuffer();
      addToPlaylist({ type: 'url', name: url.split('/').pop() || 'Nhạc từ URL', url });
      musicHistory.push({ type: 'url', name: url.split('/').pop() || 'Nhạc từ URL', url });
      localStorage.setItem('musicHistory', JSON.stringify(musicHistory));
      updateHistoryDisplay();

      audioBuffer = await (new (window.AudioContext || window.webkitAudioContext)()).decodeAudioData(arrayBuffer);
      setupAudioContext(audioBuffer);

      const fileName = url.split('/').pop() || 'Nhạc từ URL';
      musicInfo.textContent = `Đã chọn: ${fileName}`;
      btnPlayPause.disabled = false;
      btnLoop.disabled = false;
      btnEnhance.disabled = false;
      btnEnhanceMode.disabled = false;
      btnLoadUrl.disabled = false;
      volumeSlider.disabled = false;
      progressSlider.disabled = false;
      progressSlider.max = audioBuffer.duration;
      progressSlider.value = 0;

      btnPlayPause.textContent = '▶ Play';
      audioPlaying = false;
      pauseTime = 0;
      currentPlaylistIndex = playlist.length - 1;
      updatePlaylistDisplay();
      if (!lyricsData.length) {
        lyricsElement.innerHTML = '<p>Chưa có lời bài hát</p>';
      }
    } catch (error) {
      musicInfo.textContent = 'Lỗi: Không thể tải file từ URL';
      btnLoadUrl.disabled = false;
      volumeSlider.disabled = false;
      progressSlider.disabled = false;
    }
  });

  // Play / Pause
  btnPlayPause.addEventListener('click', () => {
    if (audioPlaying) {
      if (audioSource) {
        audioSource.stop();
        audioSource.disconnect();
        audioSource = null;
      }
      audioPlaying = false;
      pauseTime += audioCtx.currentTime - startTime;
      btnPlayPause.textContent = '▶ Play';
    } else {
      if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
      setupAudioContext(audioBuffer);
      startTime = audioCtx.currentTime;
      audioSource.start(0, pauseTime);
      audioPlaying = true;
      btnPlayPause.textContent = '❚❚ Pause';
      updateProgress();
      updateLyrics();
      drawWaveform();
      updateAudioSourceEnded();
    }
  });

  // Loop
  btnLoop.addEventListener('click', () => {
    loopOn = !loopOn;
    if (audioSource) audioSource.loop = loopOn;
    btnLoop.textContent = `Loop: ${loopOn ? 'On' : 'Off'}`;
  });

  // Enhance
  btnEnhance.addEventListener('click', () => {
    enhanceOn = !enhanceOn;
    btnEnhance.textContent = `Cảm Âm: ${enhanceOn ? 'On' : 'Off'}`;
    if (audioPlaying) {
      if (audioSource) {
        audioSource.stop();
        audioSource.disconnect();
        audioSource = null;
      }
      pauseTime += audioCtx.currentTime - startTime;
      setupAudioContext(audioBuffer);
      startTime = audioCtx.currentTime;
      audioSource.start(0, pauseTime);
      updateProgress();
    }
  });

  // Enhance mode
  btnEnhanceMode.addEventListener('click', () => {
    const modes = ['bass', 'vocal', 'treble', 'balanced'];
    const currentIndex = modes.indexOf(enhanceMode);
    enhanceMode = modes[(currentIndex + 1) % modes.length];
    btnEnhanceMode.textContent = `Chế độ: ${enhanceMode === 'bass' ? 'Bass Boost' : enhanceMode === 'vocal' ? 'Vocal Clarity' : enhanceMode === 'treble' ? 'Treble Boost' : 'Balanced'}`;
    if (audioPlaying && enhanceOn) {
      if (audioSource) {
        audioSource.stop();
        audioSource.disconnect();
        audioSource = null;
      }
      pauseTime += audioCtx.currentTime - startTime;
      setupAudioContext(audioBuffer);
      startTime = audioCtx.currentTime;
      audioSource.start(0, pauseTime);
      updateProgress();
    }
  });

  // Rain effect
  const rainContainer = document.getElementById('rain');
  function createDrop() {
    const drop = document.createElement('div');
    drop.classList.add('drop');
    if (Math.random() < 0.3) drop.classList.add('large');
    drop.style.left = Math.random() * window.innerWidth + 'px';
    drop.style.animationDuration = (Math.random() * 0.5 + 1.5) + 's';
    drop.style.background = `rgba(130, 155, 230, ${0.04 + Math.random() * 0.04})`;
    rainContainer.appendChild(drop);
    setTimeout(() => drop.remove(), 2000);
  }
  setInterval(createDrop, 400);

  // Upload image/GIF
  const imageFileInput = document.getElementById('imageFile');
  imageFileInput.addEventListener('change', (e) => {
    if (!e.target.files.length) return;
    const file = e.target.files[0];
    if (!file.type.startsWith('image')) {
      imagePreviewFrame.innerHTML = '<span style="color:#b66868;">Vui lòng chọn file hình ảnh/GIF hợp lệ</span>';
      return;
    }

    const img = new Image();
    const reader = new FileReader();

    reader.onload = function(evt) {
      img.onload = function() {
        const size = Math.min(img.width, img.height);
        const canvas = document.createElement('canvas');
        canvas.width = 480;
        canvas.height = 480;
        const ctx = canvas.getContext('2d');

        const sx = (img.width - size) / 2;
        const sy = (img.height - size) / 2;
        ctx.drawImage(img, sx, sy, size, size, 0, 0, 480, 480);

        imagePreviewFrame.innerHTML = '';
        const previewImg = document.createElement('img');
        previewImg.src = file.type === 'image/gif' ? evt.target.result : canvas.toDataURL('image/png');
        previewImg.alt = 'Ảnh/GIF đã resize 1x1';
        imagePreviewFrame.appendChild(previewImg);
      };
      img.src = evt.target.result;
    };
    reader.readAsDataURL(file);
  });

  // Initialize history and playlist display
  updateHistoryDisplay();
  updatePlaylistDisplay();
</script>
</body>
</html>
```
